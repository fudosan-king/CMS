{% extends "wagtailadmin/base.html" %}
{% include "wagtailadmin/macros.html" %}
{% load i18n wagtailadmin_tags %}
{% load wagtailimages_tags %}

{% block titletag %}{{ building_detail.building_name }}{% endblock %}

{% block content %}
    <header class="merged nice-padding">
        <div class="row">
            <div class="col2">
                <h1>
                	<svg class="icon icon-form header-title-icon" aria-hidden="true" focusable="false"><use href="#icon-form"></use></svg>
                        {% if building_detail %}{{ building_detail.building_name }}{% else %}{% trans 'Add' %}{% endif %}
                </h1>
            </div>
            <div class="col9">
                <span>&nbsp;</span>
            </div>
            <div class="col1">
                {% if building_detail %}
                <div class="actionbutton">
                    <a href="{% url 'upload' %}?building_id={{ building_detail.id }}" class="button bicolor button--icon"><span class="icon-wrapper"><svg class="icon icon-plus icon" aria-hidden="true" focusable="false"><use href="#icon-plus"></use></svg></span>{% trans 'Upload' %}</a>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <form method="post" action="{{ action }}" class="building-content">
        {% csrf_token %}
        <ul class="tab-nav merged" data-tab-nav="">
            <li class="active"><a href="#information">{% trans '情報' %}</a></li>
            <li><a href="#google">{% trans 'Google map 座標' %}</a></li>
            <li><a href="#room">{% trans 'ドアへの扉' %}</a></li>
            <li><a href="#renovation">{% trans 'リノベーション' %}</a></li>
            <li><a href="#fee">{% trans '費用' %}</a></li>
            {% if building_detail %}
            <li><a href="#photos">{% trans '写真' %}</a></li>
            {% endif %}
        </ul>

        <ul class="col12 errorlist">
          {% for field in forms %}
            {% if field.errors %}
              <li class="col6">
                <a href="#{{ field.name }}">{{ field.label }}: {% for error in field.errors %} {{ error }} {% endfor %}</a>
              </li>
            {% endif %}
          {% endfor %}
        </ul>


        <div class="tab-content">
            <section id="information" class="active nice-padding">
                <div class="row">
                    <div class="col6 column-content">
                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.building_name col='col12' error=forms.errors.building_name %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.structure col='col6' error=forms.errors.structure %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.ground_floors col='col6' error=forms.errors.ground_floors %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.underground_floors col='col6' error=forms.errors.underground_floors %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.built_date_year col='col2' error=forms.errors.built_date_year %}
                        <div class="col1 field-building ">
                            <span class="built-date">年</span>
                        </div>

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.built_date_month col='col2' error=forms.errors.built_date_month %}
                        <div class="col1 field-building ">
                            <span class="built-date">月</span>
                        </div>

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.total_houses col='col6' error=forms.errors.total_houses %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.management_scope col='col6' error=forms.errors.management_scope %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.area_purpose col='col6' error=forms.errors.area_purpose %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.company col='col12' error=forms.errors.company %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.constructor_label col='col6' error=forms.errors.constructor_label %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.design_club col='col6' error=forms.errors.design_club %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.management_company col='col6' error=forms.errors.management_company %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.banners_1 col='col12' error=forms.errors.banners_1 %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.banners_2 col='col12' error=forms.errors.banners_2 %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.banners_3 col='col12' error=forms.errors.banners_3 %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.banners_4 col='col12' error=forms.errors.banners_4 %}

                    </div>
                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_address.html' with pref=pref data=building_detail.address %}

                        {% include 'wagtailadmin/buildings/form_transports.html' with pref=pref data=building_detail.transports %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.land_rights col='col12' error=forms.errors.land_rights %}

                    <div>
                </div>
            </section>


            <section id="google" class="nice-padding">
                <div class="row">
                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.google_map col='col12' error=forms.errors.google_map %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.google_map_lat col='col6' error=forms.errors.google_map_lat %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.google_map_lng col='col6' error=forms.errors.google_map_lng %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.google_map_yaw col='col4' error=forms.errors.google_map_yaw %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.google_map_pitch col='col4' error=forms.errors.google_map_pitch %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.google_map_zoom col='col4' error=forms.errors.google_map_zoom %}

                    </div>
                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.elementary_school_district col='col12' error=forms.errors.elementary_school_district %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.junior_high_school_district col='col12' error=forms.errors.junior_high_school_district %}

                    </div>
                </div>
            </section>


            <section id="room" class="nice-padding">
                <div class="row">
                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.price col='col6' error=forms.errors.price %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.tatemono_menseki col='col6' error=forms.errors.tatemono_menseki %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.balcony_space col='col6' error=forms.errors.balcony_space %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.room_floor col='col6' error=forms.errors.room_floor %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.direction col='col6' error=forms.errors.direction %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.room_count col='col3' error=forms.errors.room_count %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.room_kind col='col3' error=forms.errors.room_kind %}

                    </div>

                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.management_fee col='col6' error=forms.errors.management_fee %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.repair_reserve_fee col='col6' error=forms.errors.repair_reserve_fee %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.other_fee col='col6' error=forms.errors.other_fee %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.when_to_move_in col='col6' error=forms.errors.when_to_move_in %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.limitations col='col12' error=forms.errors.limitations %}

                    </div>
            </section>


            <section id="renovation" class="nice-padding">
                <div class="row">
                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.price_full_renovation col='col6' error=forms.errors.price_full_renovation %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.link_2d col='col12' error=forms.errors.link_2d %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.link_3d col='col12' error=forms.errors.link_3d %}

                    </div>

                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.specification_description col='col12' error=forms.errors.specification_description %}

                    </div>
                </div>
            </section>


            <section id="fee" class="nice-padding">
                <div class="row">
                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.one_stop_price col='col6' error=forms.errors.one_stop_price %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.loan_borrowing col='col6' error=forms.errors.loan_borrowing %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.loan_interest_rate col='col6' error=forms.errors.loan_interest_rate %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.loan_repayment_method col='col6' error=forms.errors.loan_repayment_method %}

                    </div>

                    <div class="col6 column-content">

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.repayment_period col='col6' error=forms.errors.repayment_period %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.monthly_payment col='col6' error=forms.errors.monthly_payment %}

                        {% include 'wagtailadmin/buildings/form_input.html' with field=forms.bonus_payment col='col6' error=forms.errors.bonus_payment %}

                    </div>
                </div>
            </section>


            <section id="photos" class="nice-padding">
                <div class="col12 photos-building">
                    {% for photo in building_detail.photos %}
                    <div class="col3 item-photo-{{ forloop.counter }}" id="item-photo">
                        <div align="right">
                            <button type="button" class="close-photo">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="photo" data-image="photo-{{ forloop.counter }}" data-path="path-{{ forloop.counter }}">
                            <img src="{% if photo.path %}{{ photo.path }}{% else %}/static/images/no-image.png{% endif %}" id="photo-{{ forloop.counter }}" data-toggle="modal" data-target="#listPhotos">
                        </div>
                        <input type="hidden" name="path" value="{{ photo.path }}" id="path-{{ forloop.counter }}">
                        <select name="category">
                            {% for k, v in category %}
                                <option value="{{ k }}" {% if v == photo.category %}selected{% endif %}>{{ v }}</option>
                            {% endfor %}
                        </select>
                        <textarea name="comment">{{ photo.comment }}</textarea>
                    </div>
                    {% endfor %}
                </div>
                <div class="col12 button-add-photo" align="right">
                    <button type="button" class="button button-secondary insert-photo" onclick="insertPhoto()">+ <svg class="icon icon-user header-title-icon" aria-hidden="true" focusable="false"><use href="#icon-image"></use></svg></button>
                </div>
            </section>
        </div>

        {% if building_detail %}
            <div class="button-submit button-submit-right" align="center">
                <button type="submit" class="button button-save">{% trans 'Save' %}</button>
            </div>
        {% else %}
            <div class="button-submit" align="center">
                <button type="submit" class="button button-center">{% trans '作成する' %}</button>
            </div>
        {% endif %}
    </form>
    {% if building_detail %}
        <form method="post" action="{% url 'buildings_show' building_detail.id %}" class="building-content-remove">
            {% csrf_token %}
            <div class="button-submit button-submit-left" align="center">
                <input type="hidden" name="remove" value="{{ building_detail.id }}">
                <button class="button button-remove" type="submit" onclick="return confirm('Are you sure you want to remove this item?');">{% trans 'Remove' %}</button>
            </div>
        </form>
    {% endif %}

    <div class="modal" tabindex="-1" role="dialog" id="listPhotos">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        {% for photo in photos %}
                        <div class="col3 galary" data-photo="" data-path="">
                            {% image photo original %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer" align="center">
                </div>
        </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block extra_js %}
    <script>
        $('#listPhotos').modal('hidden');

        // Function add div photo
        function insertPhoto(){
            var random = Math.floor(Math.random() * 200) + 100;
            $('.photos-building').append(`
                <div class="col3 item-photo-` + random + `" id="item-photo">
                    <div align="right">
                        <button type="button" class="close-photo">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="photo" data-image="photo-` + random + `" data-path="path-` + random + `">
                        <img src="/static/images/no-image.png"  id="photo-` + random + `" data-toggle="modal" data-target="#listPhotos">
                    </div>
                    <input type="hidden" name="path" value="" id="path-` + random + `">
                    <select name="category">
                            {% for k, v in category %}
                                <option value="{{ k }}">{{ v }}</option>
                            {% endfor %}
                        </select>
                    <textarea name="comment"></textarea>
                </div>
            `);
        };

        $(function(){
            // Remove photo
            $('.photos-building').on('click', '.close-photo', function(){
                $(this).parent().parent().remove();
            });

            // Set photo ID to galary
            $('.photos-building').on('click', '.photo', function(){
                $('.galary').attr('data-photo', $(this).data('image'));
                $('.galary').data('photo', $(this).data('image'));

                $('.galary').attr('data-path', $(this).data('path'));
                $('.galary').data('path', $(this).data('path'));
            });

            // Set photo from galary to tab photo
            $('#listPhotos').on('click', '.galary', function(){
                var photo = $(this).data('photo');
                var path = $(this).data('path');
                var galary = $(this).find('img').attr('src');

                $('#' + photo).attr('src', galary);
                $('#' + path).val(galary);

                $('#listPhotos').modal('toggle');
            });

            // Drag and drop photo (Sort)
            $('.photos-building').sortable({
                update: function (event, ui) {
                    ui.item.addClass('#item-photo');
                }
            });

            $('#id_built_date').datetimepicker({
              format: 'Y-m-d',
            });

            $('#id_when_to_move_in').datetimepicker({
              format: 'Y-m-d',
            });

            // Set address
            $('[id=id_pref]').change(function() {
                var pref = $('#id_pref').val();
                $('#id_city option').remove();
                $('#id_ooaza option').remove();
                $('#id_tyoume option').remove();
                $('#id_hidden').val('');
                $('#id_city').append(new Option('↓(市区町村)', ''));
                $('#id_ooaza').append(new Option('↓(町域)', ''));
                $('#id_tyoume').append(new Option('↓(丁目)', ''));
                if (pref) {
                    $.ajax({
                    method: 'GET',
                    url: '/api/locations/' + pref + '/',
                    }).done(function(data) {
                        for (i=0; i<data.length; i++){
                            $('#id_city').append(new Option(data[i], data[i]));
                        }
                    });
                }

            });
            $('[id=id_city]').change(function() {
                var pref = $('#id_pref').val();
                var city = $('#id_city').val();
                $('#id_ooaza option').remove();
                $('#id_tyoume option').remove();
                if (pref && city){
                    $.ajax({
                    method: 'GET',
                    url: '/api/locations/' + pref + '/' + city + '/',
                    }).done(function(data) {
                        $('#id_ooaza').append(new Option('↓(町域)', ''));
                        $('#id_tyoume').append(new Option('↓(丁目)', ''));
                        for (i=0; i<data.length; i++){
                            $('#id_ooaza').append(new Option(data[i], data[i]));
                        }
                    });
                }

            });
            $('[id=id_ooaza]').change(function() {
                var pref = $('#id_pref').val();
                var city = $('#id_city').val();
                var ooaza = $('#id_ooaza').val();
                $('#id_tyoume option').remove();
                if (pref && city && ooaza){
                    $.ajax({
                    method: 'GET',
                    url: '/api/locations/' + pref + '/' + city + '/' + ooaza + '/',
                    }).done(function(data) {
                        $('#id_tyoume').append(new Option('↓(丁目)', ''));
                        for (i=0; i<data.length; i++){
                            $('#id_tyoume').append(new Option(data[i], data[i]));
                        }
                    });
                }

            });
            // End set address

            // Set transports
            $('[id=id_pref_transports]').change(function() {
                var pref = $(this).val();
                var transport = $(this).parent().parent().parent();
                transport.find('#id_station_name option').remove();
                transport.find('#id_station_to option').remove();
                transport.find('#id_walk_mins').val('');
                if (pref) {
                    $.ajax({
                    method: 'GET',
                    url: '/api/railroad/' + pref + '/',
                    }).done(function(data) {
                        for (i=0; i<data.length; i++){
                            transport.find('#id_station_name').append(new Option(data[i], data[i]));
                        }
                    });
                }
            });
            $('[id=id_station_name]').change(function() {
                var station_name = $(this).val();
                var transport = $(this).parent().parent().parent();
                var pref = transport.find('#id_pref_transports').val();
                transport.find('#id_station_to option').remove();
                transport.find('#id_walk_mins').val('');
                if (pref && station_name) {
                    $.ajax({
                    method: 'GET',
                    url: '/api/railroad/' + pref + '/' + station_name + '/',
                    }).done(function(data) {
                        for (i=0; i<data.length; i++){
                            transport.find('#id_station_to').append(new Option(data[i], data[i]));
                        }
                    });
                }
            });
            // End set transports

        });

    </script>
{% endblock %}
